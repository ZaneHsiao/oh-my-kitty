# ============================
# tmux.conf (Kitty + macOS + nvim friendly)
# ============================

# --- Terminal / Colors (CRITICAL for nvim) ---
# Kitty 推荐：固定成 xterm-kitty，避免 ${TERM} 漂移导致 nvim/键位/真彩异常
set -g default-terminal "xterm-kitty"
set -g set-clipboard on
# Truecolor
set -as terminal-overrides ",xterm-kitty:RGB"
set -as terminal-overrides ",*:Tc"

# Allow extended keys (Cmd/Alt modifiers from kitty)
set -s extended-keys on
set -as terminal-features 'xterm-kitty:extkeys'


# --- Prefix / Key timing ---
set -g prefix C-a
unbind C-b
bind C-a send-prefix
set -s escape-time 0

# --- Basic behavior ---
set -g detach-on-destroy off
set -g renumber-windows on

# Window and pane index from 1
set -g base-index 1
setw -g pane-base-index 1

# Mouse
# Disable mouse capture so terminal selection + Cmd+C works in tmux.
set -g mouse off

# Copy-mode uses vi keys
setw -g mode-keys vi

# Status bar position
set -g status-position top

# Scrollback
set -g history-limit 1000000

# Pane borders
set -g pane-active-border-style 'fg=magenta,bg=default'
set -g pane-border-style 'fg=brightblack,bg=default'

# --- Title: session + relative path ---
set -g set-titles on
set -g set-titles-string "#S #{s|$HOME|~|:pane_current_path}"

# --- Window name: session + relative path ---
set -g automatic-rename on
set -g automatic-rename-format "#S #{s|$HOME|~|:pane_current_path}"

# --- Catppuccin window text ---
set -g @catppuccin_window_current_text "#S #{s|$HOME|~|:pane_current_path}"
set -g @catppuccin_window_text "#S #{s|$HOME|~|:pane_current_path}"

# --- Kill shortcuts ---
bind-key x kill-pane
bind-key & kill-window

# --- Reload config ---
bind r source-file ~/.tmux.conf \; display-message "Config Reloaded."

# --- Splits keep current path ---
# Your original intent preserved; slight quoting cleanup
unbind '"'
unbind %
bind-key '\' split-pane -h -c "#{pane_current_path}"
bind-key - split-pane -v -c "#{pane_current_path}"

# --- Resize panes with Prefix + H/J/K/L ---
bind -r H resize-pane -L 5
bind -r L resize-pane -R 5
bind -r K resize-pane -U 5
bind -r J resize-pane -D 5

# --- Move between windows with Shift + Arrow keys ---
# (If this ever fails in some terminals, switch to M-Left/M-Right)
bind -n S-Left  previous-window
bind -n S-Right next-window

# ============================
# nvim + tmux navigator (smart pane switching)
# ============================
# If current pane runs (n)vim/fzf, pass Ctrl-h/j/k/l into it; otherwise move tmux pane.
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
  | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

# ============================
# macOS Cmd-like keys in Kitty + tmux
# ============================
# Cmd+A/C/V from kitty are sent as C-S-a/c/v
bind-key -T copy-mode-vi 'C-S-a' send -X select-all
bind-key -T copy-mode-vi 'C-S-c' send -X copy-pipe-and-cancel "pbcopy"

# Cmd+V paste behavior: if vim is active, pass through; otherwise paste from system clipboard.
bind-key -n 'C-S-v' if-shell "$is_vim" 'send-keys C-S-v' 'run-shell "pbpaste | tmux load-buffer - \; tmux paste-buffer"'

# ============================
# fzf-url options
# ============================
set -g @fzf-url-fzf-options '-p 60%,30% --prompt="   " --border-label=" Open URL "'
set -g @fzf-url-history-limit '2000'

# ============================
# Plugins (TPM)
# ============================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'catppuccin/tmux'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'omerxx/tmux-sessionx'
set -g @plugin 'omerxx/tmux-floax'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'


# sessionx
set -g @sessionx-bind 'o'
set -g @sessionx-window-height '85%'
set -g @sessionx-window-width '75%'

# floax
set -g @floax-width '80%'
set -g @floax-height '80%'
set -g @floax-border-color 'magenta'
set -g @floax-text-color 'blue'
set -g @floax-bind 'p'
set -g @floax-change-path 'false'

# continuum / resurrect
set -g @continuum-restore 'on'
set -g @resurrect-strategy-nvim 'session'

# catppuccin theme
set -g @catppuccin_flavour 'mocha'
set -g @catppuccin_status_default "on"
set -g @catppuccin_status_background "default"
set -g @catppuccin_status_justify "centre"

set -g @catppuccin_window_left_separator ""
set -g @catppuccin_window_right_separator " "
set -g @catppuccin_window_middle_separator " | "
set -g @catppuccin_window_number_position "right"
set -g @catppuccin_window_current_fill "all"
set -g @catppuccin_window_current_text "#{b:pane_current_path}"

set -g @catppuccin_status_modules_left "session"
set -g @catppuccin_status_modules_right "date_time weather cpu mem battery"
set -g @catppuccin_status_left_separator  " "
set -g @catppuccin_status_right_separator ""
set -g @catppuccin_status_fill "icon"
set -g @catppuccin_status_connect_separator "no"
set -g @catppuccin_date_time_text "%Y-%m-%d %H:%M"
set -g @catppuccin_weather_text "#($HOME/.tmux/scripts/status_weather.sh)"
set -g @catppuccin_cpu_text "CPU #{cpu_percentage}"
set -g @catppuccin_mem_text "MEM #($HOME/.tmux/scripts/status_mem.sh)"

# Refresh status line periodically for time/weather updates
set -g status-interval 5

# ============================
# TPM bootstrap + run
# ============================
# Your original "if" was invalid in tmux; use if-shell.
if-shell 'test ! -d ~/.tmux/plugins/tpm' \
  'run-shell "git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm"'

run -b '~/.tmux/plugins/tpm/tpm'
